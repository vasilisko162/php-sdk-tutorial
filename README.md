Пример интеграции php-приложения с сервисом Простые Звонки
==========================================================

Простые Звонки - сервис для интеграции клиентских приложений (Excel, 1C и ERP-cистем) с офисными и облачными АТС. Клиентское приложение может общаться с сервером Простых Звонков через единый API, независимо от типа используемой АТС. 

В данном примере мы рассмотрим процесс подключения к серверу Простых Звонков веб-приложения, написанного на PHP. Мы начнём с веб-приложения, выводящего на экран список клиентов из базы данных, и добавим в него следующие функции:

- отображение всплывающей карточки при входящем звонке;
- звонок клиенту по клику на телефоный номер.

Каждый шаг данного руководства представлен собственным тэгом в репозитории. Например, чтобы посмотреть версию кода, соответствующую первому шагу, нужно выполнить следующую команду:

```bash
git checkout 1
```

> Если вы не знакомы с системой контроля версий git - ничего страшного. Просто загрузите [архив] с файлами, распакуйте его и откройте в любимом редакторе.

**Обратите внимание:** данное приложение написано исключительно в образовательных целях. Для того, чтобы сделать код прощё и понятней, в нём намеренно опущены такие важные штуки, как обработка ошибок и граничных ситуаций, валидация и экранирование данных.

Для начала посмотрим, как устроена интеграция CRM-системы с сервером Простых Звонков:

![Функциональная схема](https://github.com/vedisoft/php-sdk-tutorial/raw/master/img/functional-diagram.png)

Модуль PHP SDK запускает процесс listener_process.php, который устанавливает постоянное соединение с сервером CTI по протоколу WebSockets. Модуль обрабатывает получаемые от сервера события (например, событие входящего звонка или запроса на перевод) и сохраняет их в отдельные файлы в папку storage/events. Клиент отправляет HTTP-запросы (например, на создание исходящего звонка или на получение информации о входящих звонках) CRM-системе с помощью технологии AJAX.

Шаг 0. Исходное приложение
--------------------------

Наше исходное приложение умеет показывать список клиентов. В качестве базы данных используется файл storage/contacts.csv. Прочитанные из файла строки отображаются в виде таблицы.

![Исходное приложение](https://github.com/vedisoft/php-sdk-tutorial/raw/master/img/tinycrm-origin.png)

Шаг 1. Настройка подключения к серверу
--------------------------------------

Скачаем и распакуем архив [php-sdk]. В папке ProstieZvonki находится бибиотека, ответственная за взаимодействие с сервером Простых Звонков, а в папке TestSuite - утилиты для тестирования. Скопируем обе папки в наш проект. Переименуем файл config.ini.example в config.ini. 

> У веб-сервера должны быть права на запись в папку storage и её подпапки, а также в папку lib/ListenerProcess и файл config.ini. 

Для тестирования используются две утилиты. TestServer.exe - эмулятор сервера Простых Звонков. Diagnostic.exe - утилита для управления тестовым сервером. Обе утилиты запускаются из командной строки.

> Для запуска в операционной системе Linux можно использовать Wine.

Запустим тестовый сервер:

```bash
TestSuite/TestServer.exe -r
```

и подключимся к нему диагностической утилитой:

```bash
TestSuite/Diagnostic.exe

[events off]> Connect localhost:10150 asd
Успешно начато установление соединения с АТС
```

Теперь добавим лицензию для нашего приложения:

```bash
[events off]> Licence 1 10 tinyCRM
```

> Первый аргумент команды Licence говорит о том, что лицензии нужно добавить (1) или удалить (0). Второй аргумент — количество пользователей, которые могут подключаться к серверу одновременно. Третий аргумент — тип клиентского приложения (напрмер, excel или 1C).

Тестовое окружение настроено.

Добавим на страницу веб-приложения индикатор состояния соединения с сервером и кнопку, по нажатию на которую мы будем устанавливать соединение.

```html
<span id="button" class="btn pull-right">Соединить</span>
<span id="indicator" class="badge">Проверка соединения...</span>
```

Теперь наше приложение выглядит так:

![Индикатор состояния соединения](https://github.com/vedisoft/php-sdk-tutorial/raw/master/img/connection-indicator.png)

Приложение будет управлять соединением посредством ajax-запросов, поэтому нам нужно подготовить небольшой обработчик. Создадим в папке public файл ajax.php и добавим в него следующий код:

```php
<?php

require_once '../ProstieZvonki/ProstieZvonki.php';

$pz = ProstieZvonki::getInstance();

echo call_user_func($_GET['action'], $pz, $_GET);
```

Теперь, чтобы добавить новый тип ajax-запроса, нам нужно всего лишь объявить функцию с двумя аргументами: объектом класса ProstieZvonki (он будет выполнять всю работу по взаимодействию с сервером) и массив с GET-параметрами.

> Подробное описание API библиотеки php-sdk можно найти [тут](https://github.com/vedisoft/php-sdk#api).

Добавим функции для подключения, отключения и получения информации о состоянии соединения:

```php
function is_connected(ProstieZvonki $pz, array $input) {
	return $pz->isConnected();
}

function connect(ProstieZvonki $pz, array $input) {
	$pz->connect(array(
		'client_id'     => '101',       // Пароль
		'client_type'   => 'tinyCRM',   // Тип приложения
		'host'          => 'localhost', // Хост сервера
		'port'          => '10150',     // Порт сервера
	));
}

function disconnect(ProstieZvonki $pz, array $input) {
	$pz->disconnect();
}
```

Перейдём к настройки клиентской части приложения.

Добавим обработчик события кнопки. По нажатию кнопки будет выполнять запрос на подключение либо отключение соединения с сервером:

```js
$('#button').on('click', function() {
	if ($(this).text() === 'Соединить') {
		$.getJSON('ajax.php', { 'action': 'connect' });
	} else {
		$.getJSON('ajax.php', { 'action': 'disconnect' });
	}
});
```

Также добавим запрос информации о состоянии соединения с интервалом в одну секунду:

```js
setInterval(function() {
	$.getJSON(
		'ajax.php',
		{ 'action': 'is_connected' },
		function(data) {
			if (data) {
				$('#indicator')
					.removeClass('badge-important')
					.addClass('badge-success')
					.text('Соединение установлено');
				$('#button').text('Разъединить');
			} else {
				$('#indicator')
					.removeClass('badge-success')
					.addClass('badge-important')
					.text('Нет соединения');
				$('#button').text('Соединить');
			}
		}
	);
}, 1000);
```

Попробуем подключиться к серверу:

![Соединение установлено](https://github.com/vedisoft/php-sdk-tutorial/raw/master/img/connection-established.png)

Шаг 2. Исходящие звонки кликом по номеру
----------------------------------------

Для начала, сделаем номера телефонов клиентов ссылками:

```html
<td width="1%" nowrap>
    <span title="Позвонить" class="btn-link make-call">
        <?= $contact[1] ?>
    </span>
</td>
```

![Делаем телефоны ссылками](https://github.com/vedisoft/php-sdk-tutorial/raw/master/img/phone-links.png)

Добавим функцию в файл ajax.php:

```php
function call(ProstieZvonki $pz, array $input) {
	$pz->call($input['from'], $input['to']);
}
```

Теперь добавим на страницу обработчики нажатия на ссылки:

```js
$('body').on('click', '.make-call', function() {
	var user_phone   = '101'; // Внутренний номер сотрудника.
	                          // В многопользовательском приложении этот номер
	                          // будет храниться в настройках пользователя
	var client_phone = $(this).text().trim();

	$.getJSON('ajax.php', { 'action': 'call', from: user_phone, to: client_phone });
});
```

Кликнув на номер клиента, посмотрим на вывод тестового сервера:

```
Call event from CRM: src = 101, dst = +7 (343) 0112233
```

Как мы видим, сервер получил запрос на создание исходящего звонка с номера 101 на номер +7 (343) 0112233.

Шаг 3. Всплывающая карточка входящего звонка
--------------------------------------------

Добавим очередную функцию в ajax.php:

```php
function get_events(ProstieZvonki $pz, array $input) {
	return json_encode($pz->getEvents());
}
```

На страницу поместим скрытый контейнер, который мы будем использовать в качестве всплывающей карточки:

```html
<div style="display: none;" class="alert alert-info"></div>
```

Осталось добавить функцию, которая будет раз в секунду запрашивать список полученных событий. Если среди событий находится событие входящего вызова на менеджера (то есть событие с типом "2"), будет отображена карточка с информацией по этому вызову.

> Подробное описание всех типов событий представлено в [документации](https://github.com/vedisoft/php-sdk#--4).

```js
setInterval(function() {
	$.getJSON(
		'ajax.php',
		{ 'action': 'get_events' },
		function(data) {
			var events = data;

			for (var i in events) {
				if (events.hasOwnProperty(i)) {
					var event = events[i];

					if (event.type === "2") {
						$('.alert').text('Звонок с '+event.from+' на '+event.to).show();
					}
				}
			}
		}
	);
}, 1000);
```

Чтобы проверить работу всплывающей карточки, создадим входящий звонок с номера 73430112233 на номер 101 с помощью диагностической утилиты Diagnostic.exe:

```
[events off]> Generate transfer 73430112233 101
```

На странице приложения должна незамедлительно появиться карточка:

![Карточка входящего звонка](https://github.com/vedisoft/php-sdk-tutorial/raw/master/img/incoming-popup.png)

Ура!
----

Теперь наше приложение умеет показывать карточки со входящими звонками, а пользователь может позвонить клиенту в один клик. 

Настройка заняла совсем немного времени, ведь так? : )

[архив]: https://github.com/vedisoft/php-sdk-tutorial/archive/master.zip
[php-sdk]: https://github.com/vedisoft/php-sdk/archive/master.zip